# -----------------------------------------------------------------------------
#               CITRON FRESH BUILD WORKFLOW
# -----------------------------------------------------------------------------
# This workflow clones the latest official Citron source, applies your custom
# patch, and builds the Android APK.

name: Build Citron Fresh

concurrency:
  group: build-citron-fresh-${{ github.ref }}
  cancel-in-progress: true

on:
  # Allows you to run this workflow manually from the Actions tab.
  workflow_dispatch:

  # Triggers the workflow when you push to the specified branches.
  push:
    branches:
      - main
      - Citron-Git-Fresh # <-- Your new branch

  # Triggers the workflow after the "Sync Upstream Fork" workflow succeeds.
  # Make sure the name "Sync Upstream Fork" is exactly correct.
  workflow_run:
    workflows: ["Sync Upstream Fork"]
    types:
      - completed

jobs:
  android:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    name: "Android (Lyfb)"

    env:
      TARGET: Lyfb
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_COMPILERCHECK: content
      CCACHE_SLOPPINESS: time_macros

    steps:
      # Step 1: Checkout your repository to get access to the patch file and build script.
      - name: Checkout Workflow Repository
        uses: actions/checkout@v4

      # Step 2: Install the required build tools.
      - name: Install Dependencies
        run: |
          sudo rm /var/lib/man-db/auto-update
          sudo apt-get update -y
          sudo apt-get install ccache glslang-tools libvulkan-dev python3-requests -y

      # Step 3: Clone the official Citron repository with all its submodules.
      - name: Clone Fresh Citron Source Code
        run: |
          echo "Cloning latest source from official Citron repository..."
          git clone --recurse-submodules 'https://git.citron-emu.org/Citron/Emulator.git' ./citron

      # Step 4: Apply your custom patch to the cloned source code.
      - name: Apply Android Patch
        working-directory: ./citron
        run: |
          # Uses the patch file from your repository and applies it to the cloned code.
          git apply ${{ github.workspace }}/.github/patches/0001-load-system-driver-directly.patch
          echo "Android patch applied successfully."

      # Step 5: Restore the compiler cache to speed up the build.
      # This single step handles both restoring and saving the cache.
      - name: Cache ccache directory
        uses: actions/cache@v4
        id: ccache-cache
        with:
          path: ${{ env.CCACHE_DIR }}
          # This key ensures the cache is reused for subsequent builds on the same branch.
          key: ${{ runner.os }}-android-ccache-${{ env.TARGET }}-${{ github.ref_name }}-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-android-ccache-${{ env.TARGET }}-${{ github.ref_name }}-
            ${{ runner.os }}-android-ccache-${{ env.TARGET }}-

      # Step 6: Run your custom build script to compile the APK.
      - name: Compile Citron Android
        run: |
          # This assumes your build script is in the root of your repository.
          chmod +x ./citron-android.sh
          ./citron-android.sh

      # Step 7: Upload the final APK as a downloadable artifact.
      - name: Upload Artifact
        uses: actions/upload-artifact@v5
        with:
          name: citron-android-${{ env.TARGET }}
          # The path is corrected to look inside the 'citron' directory where the build happened.
          path: citron/src/android/artifacts/
